name: Create Release Tag

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would happen)'
        type: boolean
        default: false

jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tags

      - name: Get version from packages
        id: version
        run: |
          # Get versions from all packages
          ROOT_VERSION=$(node -p "require('./package.json').version")
          TRANSPORT_VERSION=$(node -p "require('./packages/transport/package.json').version")
          BROWSER_VERSION=$(node -p "require('./packages/browser-transport/package.json').version")
          TUI_VERSION=$(node -p "require('./packages/tui/package.json').version")
          TAURI_VERSION=$(node -p "require('./packages/desktop/src-tauri/tauri.conf.json').version")
          PYTHON_VERSION=$(grep -Po '(?<=version = ")[^"]*' python/pyproject.toml)

          echo "Root:             $ROOT_VERSION"
          echo "Transport:        $TRANSPORT_VERSION"
          echo "Browser-Transport: $BROWSER_VERSION"
          echo "TUI:              $TUI_VERSION"
          echo "Desktop (Tauri):  $TAURI_VERSION"
          echo "Python:           $PYTHON_VERSION"

          # Check if all versions match
          if [ "$ROOT_VERSION" != "$TRANSPORT_VERSION" ] || \
             [ "$ROOT_VERSION" != "$BROWSER_VERSION" ] || \
             [ "$ROOT_VERSION" != "$TUI_VERSION" ] || \
             [ "$ROOT_VERSION" != "$TAURI_VERSION" ] || \
             [ "$ROOT_VERSION" != "$PYTHON_VERSION" ]; then
            echo ""
            echo "::error::Version mismatch detected! All packages must have the same version."
            echo "sync=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo ""
          echo "All versions are in sync: $ROOT_VERSION"
          echo "version=$ROOT_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$ROOT_VERSION" >> $GITHUB_OUTPUT
          echo "sync=true" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        id: check_tag
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG already exists!"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag $TAG does not exist, will create..."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create and push tag
        if: steps.check_tag.outputs.exists == 'false' && github.event.inputs.dry_run != 'true'
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "::notice::Created and pushed tag $TAG"

      - name: Dry run
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "DRY RUN - Would create tag: v${{ steps.version.outputs.version }}"

      - name: Summary
        run: |
          echo "## ðŸ·ï¸ Release Tag" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_tag.outputs.exists }}" == "true" ]; then
            echo "âš ï¸ Tag already exists - no action taken" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "ðŸ§ª Dry run - tag was NOT created" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Tag created and pushed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This will trigger:" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ npm publish (@abbacchio/transport, @abbacchio/browser-transport, @abbacchio/tui)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ PyPI publish (abbacchio-transport)" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ–¥ï¸ Desktop release (Windows, macOS, Linux)" >> $GITHUB_STEP_SUMMARY
          fi
